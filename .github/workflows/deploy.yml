name: Deploy Fuwari to Pages-Repo

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ForestBlog-Source
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'  # 暂时使用npm缓存，避免pnpm缓存冲突

      # 关键改进：通过npm安装pnpm（更可靠，确保加入PATH）
      - name: Install pnpm via npm
        run: |
          npm install -g pnpm  # 全局安装pnpm
          pnpm --version  # 验证安装
          which pnpm  # 显示pnpm安装路径（用于调试）
          echo "PNPM_PATH=$(which pnpm | sed 's/\/pnpm$//')" >> $GITHUB_ENV  # 提取pnpm路径

      # 强制将pnpm路径添加到PATH
      - name: Add pnpm to PATH
        run: |
          echo "$PNPM_PATH" >> $GITHUB_PATH
          echo "Current PATH: $PATH"  # 显示当前PATH（用于调试）

      # 再次验证pnpm是否可用
      - name: Verify pnpm installation again
        run: |
          pnpm --version
          which pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Build Fuwari site
        run: pnpm run build

      - name: Setup SSH key for Pages-Repo
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}

      - name: Deploy to Pages-Repo
        run: |
          cd dist
          git init
          git config --global user.name "DerckHanna"
          git config --global user.email "2261629229@qq.com"
          git remote add origin git@github.com:DerckHanna/Pages-Repo.git
          git checkout -b gh-pages
          git add .
          git commit -m "Auto deploy from ForestBlog-Source: $(date +'%Y-%m-%d %H:%M:%S')"
          git push -f origin gh-pages
    